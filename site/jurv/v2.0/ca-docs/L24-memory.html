<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>存储器实验 :: RISC-V CPU设计实验教程</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">RISC-V CPU设计实验教程</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="http://welab.ujs.edu.cn/new" target="_blank">Home</a>

        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://gitee.com/fpga-lab/jurv-open" target="_blank">openJURV</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="jurv" data-version="v2.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">RISC-V CPU设计实验教程</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">前言</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../brief-of-parts.html">实验内容的组织</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../video-links.html">教学视频资源</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">实验工具和环境</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../L02-lab-tools.html">实验工具和环境概述</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">实验前的准备工作</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../L0-install-software.html">安装软件</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../L0-download-resource.html">下载实验材料</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../L0-mooc-video.html">登录慕课平台</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../L0-welab-login.html">登录远程实验平台</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">设计工具</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../L01-guide.html">Quartus FPGA设计流程</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../L01c-quartus-revision.html">线上线下混合模式的工程设置</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">验证环境</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../L02-guide-remote.html">远程实验验证流程</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../L02-guide-local-welab.html">本地实验验证流程-WeLab版</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../L02-guide-local-julab.html">本地实验验证流程-JULAB版</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Verilog与逻辑电路实验</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/sv1-introduction.html">Verilog HDL概述</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/sv2-grammar.html">Verilog HDL语法概要</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/sv3-1-combinational.html">用assign持续赋值语句描述组合逻辑</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/L11-tristate_mux.html">三态门和多路器实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/sv3-2-combinational.html">用always过程语句描述组合逻辑</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/sv5-hierarchical.html">层次化和参数化设计</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/L12-decoder.html">译码器实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/sv4-sequential.html">时序逻辑的Verilog HDL描述</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/L13-register_file.html">寄存器堆实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/L14-shift_led.html">流水灯与移位寄存器实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/L15-counter_divider.html">计数器与分频器实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/sv6-control.html">顺序控制逻辑的Verilog HDL描述</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/L16-led_pattern_controller.html">彩灯控制器实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sv-docs/L17-stream_cipher.html">流密码器实验</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">计算机组成实验</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="L21-add_sub_operation.html">加减运算电路实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="L22-arithmetic_logic_unit.html">算术逻辑单元实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="L23-single_cycle_datapath.html">单周期数据通路实验</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="L24-memory.html">存储器实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="L25-hardwire_controller.html">硬布线控制实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="L26-riscv_assembly.html">RISC-V汇编语言实验</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="L27-riscv_micro_architecture.html">RISC-V微架构实验</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">RISC-V CPU设计实验</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../rv-docs/RV01-guide.html">实现ADDI指令</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../rv-docs/RV15-guide.html">实现整数运算指令</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../rv-docs/RV17-guide.html">实现访存指令和简单IO</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../rv-docs/RV23-guide.html">实现分支指令</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../rv-docs/RV23PL-guide.html">初步实现流水线</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../rv-docs/RV27-guide.html">支持27条指令（单周期）</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../rv-docs/RV27PL1-guide.html">解决流水线数据冲突</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../rv-docs/RV27PL2-guide.html">解决流水线控制冲突</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">RISC-V CPU设计实验教程</span>
    <span class="version">2023秋</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../../../teach/index.html">FPGA实验云 ● 教师指南</a></div>
    </li>
    <li class="component is-current">
      <div class="title"><a href="../index.html">RISC-V CPU设计实验教程</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">2023秋</a>
        </li>
        <li class="version">
          <a href="../../v1.0/index.html">2023春</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">RISC-V CPU设计实验教程</a></li>
    <li>计算机组成实验</li>
    <li><a href="L24-memory.html">存储器实验</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">2023秋</button>
  <div class="version-menu">
    <a class="version is-current" href="L24-memory.html">2023秋</a>
    <a class="version" href="../../v1.0/ca-docs/L24-memory.html">2023春</a>
  </div>
</div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="页内目录" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">存储器实验</h1>
<div class="sect1">
<h2 id="_实验目的"><a class="anchor" href="#_实验目的"></a>实验目的</h2>
<div class="sectionbody">
<div class="paragraph">
<p>1．理解存储器的特性；</p>
</div>
<div class="paragraph">
<p>2．掌握存储器的HDL描述方法；</p>
</div>
<div class="paragraph">
<p>3．了解FPGA的存储资源及使用方法。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_实验概述"><a class="anchor" href="#_实验概述"></a>实验概述</h2>
<div class="sectionbody">
<div class="paragraph">
<p>存储器是计算机中一个必不可少的部件，用来存储程序和数据。实际应用中对存储容量的要求一般比较大，通常会采用若干存储芯片组成所需要的存储器；在本课程中后面CPU设计实验中，只需要小容量的指令存储器和数据存储器配合验证CPU的设计，所以本实验学习使用FPGA内部资源来构成小容量的存储器。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_参考设计"><a class="anchor" href="#_参考设计"></a>参考设计</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FPGA内部资源可以分为逻辑资源和专用存储资源两类，都可以用来构成小容量存储器，但特性有所不同。专用存储资源只能生成同步存储器，逻辑资源可以生成同步写、异步读的存储器，也可以生成读写均异步的存储器。详细内容请看辅导视频。</p>
</div>
<div class="paragraph">
<p>FPGA设计工具如Quartus和Vivado都提供了交互式工具生成片内存储器IP核，但是可移植性不好；本实验采用HDL描述产生不同特性的片内存储器。<a href="#exa-24-1">例 1</a>和<a href="#exa-24-2">例 2</a>是两种RAM的参考设计代码，<a href="#exa-24-3">例 3</a>是ROM的参考设计，可结合辅导视频学习。更多有关Intel FPGA中存储器的描述方法，请参考《Intel® Quartus® Prime用户指南》中的设计建议：<a href="https://www.intel.cn/content/www/cn/zh/docs/programmable/683082/20-3/inferring-ram-functions-from-hdl-code.html">从HDL代码推断存储器功能</a>。</p>
</div>
<div id="exa-24-1" class="exampleblock">
<div class="title">例 1. 同步写、异步读的RAM</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>module RAM
#(  parameter ADDRWIDTH = 6,
	parameter DATAWIDTH = 32)
(
  input  wire iClk, iWR,
  input  wire [ADDRWIDTH-1:0] iAddress,
  input  wire [DATAWIDTH-1:0] iWriteData,
  output logic [DATAWIDTH-1:0] oReadData
);
  localparam MEMDEPTH = 1&lt;&lt;ADDRWIDTH; //存储器的字数 
  logic [DATAWIDTH-1:0] mem[0:MEMDEPTH-1];

  always_ff @(posedge iClk)
  begin
    if (iWR)
      mem[iAddress] &lt;= iWriteData;
  end

  assign oReadData = mem[iAddress]; // 读地址未锁存，编译器使用FPGA的逻辑资源生成存储器

  /* initial 为了调试方便可给存储器赋初值，调试成功后将其删除。
      $readmemh("init_data.txt",mem);  // 存储器内容定义在文件中。 */

endmodule</pre>
</div>
</div>
</div>
</div>
<div id="exa-24-2" class="exampleblock">
<div class="title">例 2. 同步写、同步读的RAM</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>module RAM
#(  parameter ADDRWIDTH = 6,
    parameter DATAWIDTH = 32)
(
  input  wire iClk, iWR,
  input  wire [ADDRWIDTH-1:0] iAddress,
  input  wire [DATAWIDTH-1:0] iWriteData,
  output logic [DATAWIDTH-1:0] oReadData
);
  localparam MEMDEPTH = 1&lt;&lt;ADDRWIDTH; //存储器的字数 
  logic [DATAWIDTH-1:0] mem[0:MEMDEPTH-1];
  logic [ADDRWIDTH-1:0] read_addr;

  always_ff @(posedge iClk)
  begin
    read_addr &lt;= iAddress;   //读地址锁存，编译器使用FPGA的RAM块生成存储器
    if (iWR)
      mem[iAddress] &lt;= iWriteData;
  end

  assign oReadData = mem[read_addr]; 

  /* initial 为了调试方便可给存储器赋初值，调试成功后将其删除。
      $readmemh("init_data.txt",mem);  // 存储器内容定义在文件中。 */

endmodule</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>对比<a href="#exa-24-1">例 1</a>和<a href="#exa-24-2">例 2</a>的代码，同步读RAM的读地址也经过了时钟的同步，也就是读地址被锁存了，因此比异步读的RAM在读出时慢了一个时钟周期。但是对于FPGA来说，同步读的RAM可以使用FPGA内部专用的RAM块资源，异步读的RAM则需要占用FPGA的逻辑资源。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="提示"></i>
</td>
<td class="content">
有关两种RAM的特性和比较，可观看慕课视频。
</td>
</tr>
</table>
</div>
<div id="exa-24-3" class="exampleblock">
<div class="title">例 3. ROM</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>module ROM
#(  parameter ADDRWIDTH = 4,
	parameter DATAWIDTH = 8)
(
    input  wire  [ADDRWIDTH-1:0] iAddress,
    output logic [DATAWIDTH-1:0] oData
);
    localparam MEMDEPTH = 1&lt;&lt;ADDRWIDTH;
    logic [DATAWIDTH-1:0] mem[0:MEMDEPTH-1];
    assign oData = mem[iAddress];

    initial begin <i class="conum" data-value="1"></i><b>(1)</b>
        $readmemb("init_mem.txt",mem); <i class="conum" data-value="2"></i><b>(2)</b>
        // 如果文件中的数据是十六进制，用 $readmemh
        // 也可采用如下赋值语句进行初始化
        // mem[n'h00] = n'...; <i class="conum" data-value="3"></i><b>(3)</b>
        // ......                   
    end

endmodule</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>比较RAM和ROM的端口可以发现，ROM作为只读存储器，没有写数据和写入控制端口，甚至也没有时钟端口；
就像是软件中的“数组”，存储单元的地址是数组的索引，存储单元的内容则是数组元素的值。
ROM的内容是事先写入的，对于FPGA来说，需要在设计时确定存储器的内容，称为初始化，编译时将初始值固定在电路中。在verilog中，用 <code>initial</code> 块初始化存储器的内容，如<a href="#exa-24-3">例 3</a> ①所示。
具体有两种方法，一种是用 <code>$readmemb</code> 或 <code>$readmemh</code> 系统函数，如<a href="#exa-24-3">例 3</a> ②所示；另一种是用赋值语句，如<a href="#exa-24-3">例 3</a> ③所示。
系统函数从一个文本文件读取初始化数据，<a href="#exa-24-4">例 4</a>是初始化文件的一个示例。</p>
</div>
<div id="exa-24-4" class="exampleblock">
<div class="title">例 4. init_mem.txt文件</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>@00 11000000
@01
@02
@03
@04
@05
@06
@07
@08
@09
@0A
@0B
@0C
@0D
@0E
@0F</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在 <em>init_mem.txt</em> 文件中，紧跟在 <code>@</code> 后面的是地址，然后是至少一个空白字符，再给出该地址单元的值。<a href="#exa-24-4">例 4</a>只有第一行给出了存储单元的数值，下面的各行需要学员自己完成。
如果使用 <code>$readmemb</code> 函数，编译器按二进制解释给出的存储单元的数值；如果使用 <code>$readmemh</code> 函数，则应以十六进制给出存储单元的数值。但无论哪个函数，地址始终是十六进制表示。
初始化文件中可以只初始化需要的单元，地址可以是不连续的。
如果某一行的地址与上一行是连续的，则该行的地址也可以省略不写。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="注"></i>
</td>
<td class="content">
如果使用远程实验平台的云编译功能，只能采用赋值语句的方法。目前远程实验平台未提供上传初始化文件的功能。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_实验任务"><a class="anchor" href="#_实验任务"></a>实验任务</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">1.用ROM实现七段译码器</dt>
<dd>
<p>设计一个16×8的只读存储器，存储单元中固化十六个字符0～F的数码管段码；用存储器的4位地址作为七段译码器的数据输入，相应存储单元的8位数据作为七段译码器的输出。
<a href="#exa-24-4">例 4</a>第一行给出了字符“0”的编码，其余字符编码需要自己编写。</p>
</dd>
<dt class="hdlist1">2.用RAM实现寄存器堆</dt>
<dd>
<p>在前面的寄存器堆实验中，只包含4个寄存器，用多路器选择其中一个输出；若寄存器的数量比较多，不仅描述冗长，硬件资源消耗也较多。本实验用存储器的方法设计一组32×32的三端口寄存器堆，用在以后的CPU设计中。
具体要求如下。</p>
<div class="paragraph">
<p>（1）采用异步读的RAM设计。</p>
</div>
<div class="paragraph">
<p>（2）R0寄存器的读出值始终为零。</p>
</div>
<div class="paragraph">
<p>（3）写成单独的模块，并且采用参数化的设计方法，模块端口如下。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>module RegisterFile
#(  parameter DATAWIDTH = 32,
    parameter ADDRWIDTH = 5)
(
    input  wire   iClk,
    input  wire   iWE,
    input  wire   [ADDRWIDTH-1:0] iWA, iRA1, iRA2,
    input  wire   [DATAWIDTH-1:0] iWD,
    output logic  [DATAWIDTH-1:0] oRD1, oRD2
);</pre>
</div>
</div>
</dd>
<dt class="hdlist1">3.编写VirtualBoard模块</dt>
<dd>
<p>按照<a href="#fig-24-02">图 1</a>所示虚拟面板编写VirtualBoard模块。</p>
</dd>
</dl>
</div>
<div id="fig-24-02" class="imageblock">
<div class="content">
<img src="_images/L24-img02.png" alt="image" width="361" height="250">
</div>
<div class="title">图 1. 实验任务的虚拟面板</div>
</div>
<div class="paragraph">
<p>（1）实例化用RAM实现的寄存器堆模块。</p>
</div>
<div class="paragraph">
<p>（2）实例化用ROM实现的七段译码器模块，并连接到数码管。</p>
</div>
<div class="paragraph">
<p>（3）连接虚拟元件</p>
</div>
<div class="paragraph">
<p>由于虚拟元件数量有限，只连接2位地址开关和4位数据开关，未连接到开关的剩余3位地址填充为0，或者实例化时通过传递参数实例化为4×4的三端口寄存器堆。</p>
</div>
<div class="sidebarblock text-center">
<div class="content">
<div class="title">许可 | License</div>
<div class="paragraph">
<p><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA：署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></p>
</div>
<div class="paragraph">
<p>作者：
肖铁军 &lt;<a href="mailto:xiaotiejun@foxmail.com.cn">xiaotiejun@foxmail.com.cn</a>&gt;</p>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
